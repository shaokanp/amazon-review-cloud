showProductList = function(){
  $('#product-list').animate({opacity: 1},600);
}

$('#product-list').append('<%= j render @products %>');
showProductList();

//$('#product-list').masonry({
//  itemSelector: '.product-cell'
//});

window.location.hash = '';
$('#product-list').show();
$('#product-show').hide();

productIds = [
<% @products.each do |t| %>
'<%= t.productId %>',
<% end %>];
if(productIds.length < 1) window.isAllLoaded = true

var imageLoaded = 0;
var batchRetrievalNum = 5;
ourKeyword = window.searchKeyword;
getProductImage = function(idArray){
    var idString = '';
    var i;

    for(i = 0; i < idArray.length-1; i++){
        idString = idString + idArray[i] + ',';
    }
    idString = idString + idArray[i];
    $.ajax({
        url: '/products/image_url.json?product_ids=' + idString,
        success: function (data, textStatus, jqXHR){
            for(var i = 0; i < data.length; i++){
                $('#product-list').find('span.product-id:contains(' + idArray[i] +')').parent().find('img').attr('src', data[i]);
            }
            $('#product-list').masonry({        
                itemSelector: '.product-cell',
                animate:true
            });
            imageLoaded = imageLoaded + batchRetrievalNum;
            if(imageLoaded < productIds.length && ourKeyword == window.searchKeyword){
                getProductImage(productIds.slice(imageLoaded,imageLoaded+batchRetrievalNum));
            }
        },
        error: function (jqXHR, textStatus, errorThrown){
            console.log('Get images error. ' + textStatus);
        }
    });
}

getProductImage(productIds.slice(imageLoaded,imageLoaded+batchRetrievalNum));





